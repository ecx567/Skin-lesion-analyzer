{% extends 'skin_detector/base.html' %}

{% block title %}{{ title }} - Detector de Enfermedades Cutáneas{% endblock %}

{% block content %}
<div class="row">
    <!-- Formulario de Subida -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Subir Imagen para Análisis
                </h4>
                <small>Suba una imagen de lesión cutánea para obtener un diagnóstico automático</small>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- Drop Zone -->
                    <div class="drop-zone mb-4" id="dropZone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Arrastra tu imagen aquí</h5>
                        <p class="text-muted mb-3">o haz clic para seleccionar</p>
                        {{ form.image }}
                    </div>
                    
                    <!-- Vista Previa (con recorte) -->
                    <div class="text-center mb-4" id="previewContainer" style="display: none;">
                        <div id="previewWrapper" style="position:relative; display:inline-block;">
                            <img id="imagePreview" class="image-preview" alt="Vista previa" style="display:block; max-width:100%;" />
                            <div id="previewCropOverlay" class="crop-overlay" style="display:none;"></div>
                        </div>
                        <div class="mt-2 crop-controls" style="display:none;" id="previewCropControls">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="startPreviewCropBtn">Iniciar recorte</button>
                            <button type="button" class="btn btn-sm btn-primary" id="applyPreviewCropBtn" style="display:none;">Aplicar recorte</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelPreviewCropBtn" style="display:none;">Cancelar</button>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-microscope me-2"></i>
                            Analizar Imagen
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>
                            Limpiar
                        </button>
                        <button type="button" class="btn btn-outline-info ms-2" onclick="openCameraModal()">
                            <i class="fas fa-camera me-2"></i>
                            Usar Cámara
                        </button>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div class="text-center mt-3 loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <p class="mt-2 text-muted">Analizando imagen, por favor espere...</p>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Predicción Rápida -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Análisis Rápido
                </h5>
                <small>Análisis sin guardar historial</small>
            </div>
            <div class="card-body">
                <form id="quickForm" enctype="multipart/form-data">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <input type="file" class="form-control" id="quickImage" accept="image/*" required>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="fas fa-zap me-1"></i>
                                Análisis Rápido
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Resultado Rápido -->
                <div id="quickResult" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Información y Predicciones Recientes -->
    <div class="col-lg-4">
        <!-- Información del Sistema -->
        <!-- Panel de Información del Sistema Mejorado -->
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h5 class="mb-0">
                    <i class="fas fa-brain me-2"></i>
                    Sistema de Detección IA
                </h5>
                <small class="opacity-75">Análisis automatizado de lesiones cutáneas</small>
            </div>
            <div class="card-body">
                <!-- Información de Precisión -->
                <div class="alert alert-info border-0 shadow-sm mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line fa-2x me-3 text-info"></i>
                        <div>
                            <strong>Precisión del Sistema: 92%</strong>
                            <p class="mb-0 small">Entrenado con más de 10,000 imágenes dermatológicas certificadas</p>
                        </div>
                    </div>
                </div>
                
                <h6 class="text-primary mb-3">
                    <i class="fas fa-microscope me-2"></i>
                    Enfermedades Detectables (7 Tipos):
                </h6>
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #fff5f5;">
                            <span class="badge bg-danger me-2" style="min-width: 50px;">MEL</span>
                            <div class="flex-grow-1">
                                <strong>Melanoma</strong>
                                <span class="badge bg-danger ms-2">MUY ALTA PRIORIDAD</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #fff8f0;">
                            <span class="badge bg-warning text-dark me-2" style="min-width: 50px;">BCC</span>
                            <div class="flex-grow-1">
                                <strong>Carcinoma Basocelular</strong>
                                <span class="badge bg-warning text-dark ms-2">ALTA PRIORIDAD</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #fffbf0;">
                            <span class="badge bg-warning text-dark me-2" style="min-width: 50px;">AKIEC</span>
                            <div class="flex-grow-1">
                                <strong>Queratosis Actínicas</strong>
                                <span class="badge bg-secondary ms-2">MEDIA</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #f0f8ff;">
                            <span class="badge bg-info me-2" style="min-width: 50px;">VASC</span>
                            <div class="flex-grow-1">
                                <strong>Lesiones Vasculares</strong>
                                <span class="badge bg-secondary ms-2">MEDIA</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #f0fff0;">
                            <span class="badge bg-success me-2" style="min-width: 50px;">BKL</span>
                            <div class="flex-grow-1">
                                <strong>Queratosis Benigna</strong>
                                <span class="badge bg-success ms-2">BAJA</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #f0fff0;">
                            <span class="badge bg-success me-2" style="min-width: 50px;">DF</span>
                            <div class="flex-grow-1">
                                <strong>Dermatofibroma</strong>
                                <span class="badge bg-success ms-2">BAJA</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center p-2 rounded" style="background-color: #f0fff0;">
                            <span class="badge bg-success me-2" style="min-width: 50px;">NV</span>
                            <div class="flex-grow-1">
                                <strong>Nevos Melanocíticos</strong>
                                <span class="badge bg-success ms-2">BAJA</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-6">
                        <i class="fas fa-file-image fa-2x text-primary mb-2"></i>
                        <h6 class="small mb-1">Formatos</h6>
                        <p class="small text-muted mb-0">JPG, PNG</p>
                    </div>
                    <div class="col-6">
                        <i class="fas fa-clock fa-2x text-success mb-2"></i>
                        <h6 class="small mb-1">Tiempo</h6>
                        <p class="small text-muted mb-0">2-5 seg</p>
                    </div>
                </div>
                
                <div class="alert alert-warning border-0 mt-3 mb-0">
                    <small>
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Importante:</strong> Esta herramienta es de apoyo diagnóstico. 
                        Siempre consulte con un dermatólogo profesional.
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Predicciones Recientes Mejoradas -->
        {% if recent_predictions %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Análisis Recientes
                </h5>
                <small class="opacity-75">Últimas predicciones procesadas</small>
            </div>
            <div class="card-body p-2">
                {% for prediction in recent_predictions %}
                <div class="prediction-card border rounded p-2 mb-2 hover-shadow" style="transition: all 0.3s;">
                    <div class="row align-items-center g-2">
                        <div class="col-3">
                            <img src="{{ prediction.image.url }}" alt="Imagen" 
                                 class="img-fluid rounded shadow-sm" 
                                 style="height: 70px; width: 100%; object-fit: cover;">
                        </div>
                        <div class="col-9">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0 fw-bold">{{ prediction.get_predicted_disease_name }}</h6>
                                <span class="badge 
                                    {% if prediction.predicted_class == 'mel' %}bg-danger
                                    {% elif prediction.predicted_class == 'bcc' %}bg-warning text-dark
                                    {% elif prediction.predicted_class in 'akiec,vasc' %}bg-secondary
                                    {% else %}bg-success{% endif %}">
                                    {{ prediction.predicted_class|upper }}
                                </span>
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-bullseye me-1 text-success"></i>
                                <strong>{{ prediction.get_confidence_percentage }}%</strong> confianza
                                <span class="mx-1">•</span>
                                <i class="fas fa-clock me-1 text-info"></i>
                                {{ prediction.processed_at|timesince }} atrás
                            </div>
                            <a href="{% url 'skin_detector:prediction_detail' prediction.pk %}" 
                               class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-eye me-1"></i>Ver Detalles Completos
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <div class="text-center mt-3">
                    <a href="{% url 'skin_detector:history' %}" class="btn btn-success btn-sm">
                        <i class="fas fa-history me-1"></i>
                        Ver Todo el Historial ({{ recent_predictions|length }}+ análisis)
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Advertencia -->
<div class="modal fade" id="warningModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Advertencia Médica
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Este sistema es solo una herramienta de apoyo y NO reemplaza el criterio médico profesional.</strong></p>
                <ul>
                    <li>Los resultados pueden tener errores</li>
                    <li>Siempre consulte a un dermatólogo certificado</li>
                    <li>No tome decisiones médicas basándose únicamente en esta herramienta</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    Entiendo
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal Cámara -->
    <div class="modal fade" id="cameraModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tomar Foto desde la Cámara</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="cameraStream" autoplay playsinline style="max-width:100%;"></video>
                    <canvas id="cameraCanvas" style="display:none;"></canvas>
                    <div class="mt-3">
                        <button class="btn btn-primary me-2" onclick="capturePhoto()"><i class="fas fa-camera"></i> Capturar</button>
                        <button class="btn btn-secondary" onclick="stopCamera()">Cerrar Cámara</button>
                    </div>
                    <div class="mt-3" id="cameraPreviewContainer" style="display:none;">
                        <h6>Vista previa</h6>
                        <div id="cameraPreviewWrapper" style="position:relative; display:inline-block;">
                            <img id="cameraPreview" style="max-width:100%; display:block;" />
                            <div id="cameraCropOverlay" class="crop-overlay" style="display:none;"></div>
                        </div>
                        <div class="mt-2 crop-controls" style="display:none;" id="cameraCropControls">
                            <button class="btn btn-sm btn-outline-primary" id="startCameraCropBtn">Iniciar recorte</button>
                            <button class="btn btn-sm btn-primary" id="applyCameraCropBtn" style="display:none;">Aplicar recorte</button>
                            <button class="btn btn-sm btn-outline-secondary" id="cancelCameraCropBtn" style="display:none;">Cancelar</button>
                        </div>
                        <div class="mt-2 d-flex gap-2 justify-content-center">
                            <button class="btn btn-success" onclick="useCapturedPhoto()">Usar esta foto</button>
                            <button class="btn btn-primary" onclick="analyzeAndSaveCapturedPhoto()">Analizar ahora</button>
                            <button class="btn btn-outline-secondary" onclick="retakePhoto()">Volver a capturar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Setup drag and drop
    setupDragDrop('#dropZone', $('#id_image'));
    
    // Click en drop zone
    $('#dropZone').click(function() {
        $('#id_image').click();
    });
    
    // Preview de imagen principal
    $('#id_image').change(function() {
        if (this.files && this.files[0]) {
            previewImage(this, '#imagePreview');
            $('#previewContainer').show();
        }
    });
    
    // Formulario principal
    $('#uploadForm').submit(function() {
        if (!$('#id_image')[0].files.length) {
            alert('Por favor selecciona una imagen');
            return false;
        }
        showLoading(true);
        $('#warningModal').modal('show');
        return true;
    });
    
    // Análisis rápido
    $('#quickForm').submit(function(e) {
        e.preventDefault();
        
        if (!$('#quickImage')[0].files.length) {
            alert('Selecciona una imagen para análisis rápido');
            return;
        }
        
        var formData = new FormData();
        formData.append('image', $('#quickImage')[0].files[0]);
        
        $.ajax({
            url: '{% url "skin_detector:quick_predict" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function() {
                $('#quickResult').html('<div class="text-center"><div class="spinner-border text-primary"></div><p>Analizando...</p></div>').show();
            },
            success: function(response) {
                if (response.success) {
                    displayQuickResult(response.result);
                } else {
                    $('#quickResult').html('<div class="alert alert-danger">Error: ' + response.error + '</div>');
                }
            },
            error: function() {
                $('#quickResult').html('<div class="alert alert-danger">Error en el servidor</div>');
            }
        });
    });
});

function resetForm() {
    $('#uploadForm')[0].reset();
    $('#previewContainer').hide();
    $('#quickResult').hide();
    $('#quickForm')[0].reset();
}

// Helper to read a cookie value by name (used to get CSRF token)
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function displayQuickResult(result) {
    var severityClass = getSeverityClass(result.disease_info.severity);
    
    var html = `
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Resultado del Análisis</h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center mb-3">
                    <div class="col-4">
                        <div class="progress-circle mx-auto" data-percentage="${result.confidence_percentage}">
                            <div class="progress-text">${result.confidence_percentage}%</div>
                        </div>
                    </div>
                    <div class="col-8">
                        <h5>${result.class_name_spanish}</h5>
                        <span class="severity-badge ${severityClass} text-white">${result.disease_info.severity}</span>
                    </div>
                </div>
                <p class="small">${result.disease_info.description}</p>
                <div class="alert alert-info">
                    <strong>Recomendación:</strong> ${result.disease_info.recommendation}
                </div>
                <small class="text-muted">Procesado en ${result.processing_time}s</small>
            </div>
        </div>
    `;
    
    $('#quickResult').html(html);
    
    // Actualizar círculo de progreso
    updateProgressCircle('#quickResult .progress-circle', result.confidence_percentage);
}

function getSeverityClass(severity) {
    switch(severity.toLowerCase()) {
        case 'baja': return 'severity-baja';
        case 'moderada': return 'severity-moderada';
        case 'alta': return 'severity-alta';
        case 'muy alta': return 'severity-muy-alta';
        default: return 'severity-baja';
    }
}

// ================= Camera capture functions =================
let cameraStreamTrack = null;

function openCameraModal() {
    $('#cameraModal').modal('show');
    startCamera();
}

async function startCamera() {
    const video = document.getElementById('cameraStream');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
        cameraStreamTrack = stream.getTracks()[0];
    } catch (err) {
        alert('No se pudo acceder a la cámara: ' + err.message);
        console.error(err);
        $('#cameraModal').modal('hide');
    }
}

function stopCamera() {
    const video = document.getElementById('cameraStream');
    if (video && video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(t => t.stop());
        video.srcObject = null;
    }
    cameraStreamTrack = null;
    $('#cameraModal').modal('hide');
}

function capturePhoto() {
    const video = document.getElementById('cameraStream');
    const canvas = document.getElementById('cameraCanvas');
    const previewContainer = document.getElementById('cameraPreviewContainer');
    const previewImg = document.getElementById('cameraPreview');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
    previewImg.src = dataUrl;
    previewContainer.style.display = 'block';
    // Pause the stream for preview clarity
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.enabled = false);
    }
}

function retakePhoto() {
    const previewContainer = document.getElementById('cameraPreviewContainer');
    const video = document.getElementById('cameraStream');
    previewContainer.style.display = 'none';
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.enabled = true);
    }
}

function useCapturedPhoto() {
    const canvas = document.getElementById('cameraCanvas');
    canvas.toBlob(function(blob) {
        // Crear un File a partir del Blob para ponerlo en el input file
        const file = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });

        // Crear un DataTransfer para asignar al input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        const input = document.getElementById('id_image');
        input.files = dataTransfer.files;

        // Mostrar vista previa en el formulario
        previewImage(input, '#imagePreview');
        $('#previewContainer').show();

        // Cerrar cámara y modal
        stopCamera();
    }, 'image/jpeg', 0.95);
}

async function analyzeAndSaveCapturedPhoto() {
    const canvas = document.getElementById('cameraCanvas');
    if (!canvas || !canvas.width) {
        alert('No hay foto capturada para analizar.');
        return;
    }

    canvas.toBlob(async function(blob) {
        const formData = new FormData();
        formData.append('image', blob, 'capture.jpg');

        try {
            const csrftoken = getCookie('csrftoken');
            const resp = await fetch('{% url "skin_detector:save_and_predict" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData,
                credentials: 'same-origin'
            });

            const data = await resp.json();
            if (data && data.redirect_url) {
                // Redirect to the saved prediction detail page
                window.location = data.redirect_url;
            } else if (data && data.success === false) {
                alert('Error al guardar y analizar: ' + (data.error || 'Desconocido'));
            } else {
                alert('Respuesta inesperada del servidor.');
                console.error('Respuesta inesperada:', data);
            }
        } catch (err) {
            console.error(err);
            alert('Error enviando imagen al servidor: ' + err);
        }
    }, 'image/jpeg', 0.95);
}

// ============== Simple image cropping widget ==============
let cropState = null; // {startX,startY,x,y,active,element,wrapper}

function enableCropForPreview(wrapperId, imgId, overlayId, startBtnId, applyBtnId, cancelBtnId, applyCallback) {
    const wrapper = document.getElementById(wrapperId);
    const img = document.getElementById(imgId);
    const overlay = document.getElementById(overlayId);
    const startBtn = document.getElementById(startBtnId);
    const applyBtn = document.getElementById(applyBtnId);
    const cancelBtn = document.getElementById(cancelBtnId);

    let rect = null;

    function onPointerDown(e) {
        e.preventDefault();
        const bounds = img.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const startX = clientX - bounds.left;
        const startY = clientY - bounds.top;
        rect = {startX, startY, x: startX, y: startY};
        overlay.style.display = 'block';
        overlay.style.left = startX + 'px';
        overlay.style.top = startY + 'px';
        overlay.style.width = '0px';
        overlay.style.height = '0px';
        document.addEventListener('mousemove', onPointerMove);
        document.addEventListener('mouseup', onPointerUp);
        document.addEventListener('touchmove', onPointerMove);
        document.addEventListener('touchend', onPointerUp);
    }

    function onPointerMove(e) {
        if (!rect) return;
        const bounds = img.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const currentX = Math.max(0, Math.min(bounds.width, clientX - bounds.left));
        const currentY = Math.max(0, Math.min(bounds.height, clientY - bounds.top));
        const left = Math.min(rect.startX, currentX);
        const top = Math.min(rect.startY, currentY);
        const width = Math.abs(currentX - rect.startX);
        const height = Math.abs(currentY - rect.startY);
        overlay.style.left = left + 'px';
        overlay.style.top = top + 'px';
        overlay.style.width = width + 'px';
        overlay.style.height = height + 'px';
        rect.x = left; rect.y = top; rect.w = width; rect.h = height;
    }

    function onPointerUp(e) {
        document.removeEventListener('mousemove', onPointerMove);
        document.removeEventListener('mouseup', onPointerUp);
        document.removeEventListener('touchmove', onPointerMove);
        document.removeEventListener('touchend', onPointerUp);
        if (rect && rect.w > 5 && rect.h > 5) {
            applyBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            startBtn.style.display = 'none';
            cropState = {rect, img, overlay, wrapper};
        } else {
            // No válido
            overlay.style.display = 'none';
            rect = null;
        }
    }

    function applyCrop() {
        if (!cropState) return;
        const r = cropState.rect;
        // Create canvas to crop original image at natural size
        const naturalW = img.naturalWidth;
        const naturalH = img.naturalHeight;
        const displayW = img.clientWidth;
        const displayH = img.clientHeight;
        const scaleX = naturalW / displayW;
        const scaleY = naturalH / displayH;
        const sx = Math.round(r.x * scaleX);
        const sy = Math.round(r.y * scaleY);
        const sw = Math.round(r.w * scaleX);
        const sh = Math.round(r.h * scaleY);

        const canvas = document.createElement('canvas');
        canvas.width = sw;
        canvas.height = sh;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);

        canvas.toBlob(function(blob) {
            const file = new File([blob], 'cropped.jpg', {type: 'image/jpeg'});
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            const input = document.getElementById('id_image');
            input.files = dataTransfer.files;
            // Update preview image to cropped
            const preview = document.getElementById('imagePreview');
            preview.src = URL.createObjectURL(file);
            $('#previewContainer').show();
            // Cleanup overlay and controls
            cropState.overlay.style.display = 'none';
            applyBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
            cropState = null;
        }, 'image/jpeg', 0.95);
    }

    function cancelCrop() {
        overlay.style.display = 'none';
        applyBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        startBtn.style.display = 'inline-block';
        cropState = null;
    }

    // Wire buttons
    startBtn.addEventListener('click', function() {
        if (!img.naturalWidth) {
            alert('La imagen aún no ha cargado. Espera un momento y vuelve a intentar.');
            return;
        }
        overlay.style.display = 'none';
        overlay.style.left = '0px'; overlay.style.top='0px'; overlay.style.width='0px'; overlay.style.height='0px';
        overlay.style.position = 'absolute';
        overlay.style.border = '2px dashed #0d6efd';
        overlay.style.background = 'rgba(13,110,253,0.1)';
        overlay.style.pointerEvents = 'none';
        img.style.touchAction = 'none';
        overlay.style.display = 'none';
        // Register pointer events
        img.addEventListener('mousedown', onPointerDown);
        img.addEventListener('touchstart', onPointerDown);
        applyBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    });

    applyBtn.addEventListener('click', applyCrop);
    cancelBtn.addEventListener('click', cancelCrop);
}

// Inicializar crop para preview y camera preview cuando el DOM cambie
document.addEventListener('DOMContentLoaded', function() {
    // Controls prefixes map to element ids used earlier
    // preview: startPreviewCropBtn -> controlsPrefix 'startPreviewCropBtn' etc.
    // to keep it simple, we'll use direct element ids wired below
    const startPreview = document.getElementById('startPreviewCropBtn');
    if (startPreview) {
        enableCropForPreview('previewWrapper', 'imagePreview', 'previewCropOverlay', 'startPreviewCropBtn', 'applyPreviewCropBtn', 'cancelPreviewCropBtn', null);
    }
    const startCamera = document.getElementById('startCameraCropBtn');
    if (startCamera) {
        enableCropForPreview('cameraPreviewWrapper', 'cameraPreview', 'cameraCropOverlay', 'startCameraCropBtn', 'applyCameraCropBtn', 'cancelCameraCropBtn', null);
    }
});
</script>
{% endblock %}
