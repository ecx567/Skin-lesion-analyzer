{% extends 'skin_detector/base.html' %}

{% block title %}{{ title }} - Detector de Enfermedades Cutáneas{% endblock %}

{% block content %}
<div class="row">
    <!-- Formulario de Subida -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Subir Imagen para Análisis
                </h4>
                <small>Suba una imagen de lesión cutánea para obtener un diagnóstico automático</small>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- Drop Zone -->
                    <div class="drop-zone mb-4" id="dropZone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Arrastra tu imagen aquí</h5>
                        <p class="text-muted mb-3">o haz clic para seleccionar</p>
                        {{ form.image }}
                    </div>
                    
                    <!-- Vista Previa -->
                    <div class="text-center mb-4" id="previewContainer" style="display: none;">
                        <img id="imagePreview" class="image-preview" alt="Vista previa" />
                    </div>
                    
                    <!-- Botones -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-microscope me-2"></i>
                            Analizar Imagen
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>
                            Limpiar
                        </button>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div class="text-center mt-3 loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <p class="mt-2 text-muted">Analizando imagen, por favor espere...</p>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Predicción Rápida -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Análisis Rápido
                </h5>
                <small>Análisis sin guardar historial</small>
            </div>
            <div class="card-body">
                <form id="quickForm" enctype="multipart/form-data">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <input type="file" class="form-control" id="quickImage" accept="image/*" required>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="fas fa-zap me-1"></i>
                                Análisis Rápido
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Resultado Rápido -->
                <div id="quickResult" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Información y Predicciones Recientes -->
    <div class="col-lg-4">
        <!-- Información del Sistema Mejorada -->
        <div class="card mb-4 info-panel">
            <div class="card-header bg-gradient-primary">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-brain me-2"></i>
                    SkinAI Detector
                </h5>
                <small class="text-light opacity-75">Sistema de diagnóstico inteligente</small>
            </div>
            <div class="card-body">
                <div class="info-item">
                    <i class="fas fa-microscope text-primary"></i>
                    <div>
                        <strong>Tecnología IA Avanzada</strong>
                        <p class="mb-0 text-muted small">Red neuronal convolucional entrenada con +10,000 imágenes</p>
                    </div>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-clock text-success"></i>
                    <div>
                        <strong>Análisis en Tiempo Real</strong>
                        <p class="mb-0 text-muted small">Resultados en menos de 5 segundos</p>
                    </div>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-shield-alt text-info"></i>
                    <div>
                        <strong>Precisión del 92%</strong>
                        <p class="mb-0 text-muted small">Validado con datos clínicos certificados</p>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <h6 class="text-primary mb-3">
                    <i class="fas fa-eye me-2"></i>
                    Enfermedades Detectables
                </h6>
                
                <div class="disease-list">
                    <div class="disease-item mb-2">
                        <span class="disease-badge disease-mel">MEL</span>
                        <span class="ms-2">Melanoma</span>
                        <span class="severity-indicator severity-muy-alta ms-auto">Muy Alta</span>
                    </div>
                    <div class="disease-item mb-2">
                        <span class="disease-badge disease-bcc">BCC</span>
                        <span class="ms-2">Carcinoma Basocelular</span>
                        <span class="severity-indicator severity-alta ms-auto">Alta</span>
                    </div>
                    <div class="disease-item mb-2">
                        <span class="disease-badge disease-akiec">AKIEC</span>
                        <span class="ms-2">Queratosis Actínicas</span>
                        <span class="severity-indicator severity-moderada ms-auto">Moderada</span>
                    </div>
                    <div class="disease-item mb-2">
                        <span class="disease-badge disease-vasc">VASC</span>
                        <span class="ms-2">Lesiones Vasculares</span>
                        <span class="severity-indicator severity-moderada ms-auto">Moderada</span>
                    </div>
                    <div class="disease-item mb-2">
                        <span class="disease-badge disease-bkl">BKL</span>
                        <span class="ms-2">Queratosis Benigna</span>
                        <span class="severity-indicator severity-baja ms-auto">Baja</span>
                    </div>
                    <div class="disease-item mb-2">
                        <span class="disease-badge disease-df">DF</span>
                        <span class="ms-2">Dermatofibroma</span>
                        <span class="severity-indicator severity-baja ms-auto">Baja</span>
                    </div>
                    <div class="disease-item">
                        <span class="disease-badge disease-nv">NV</span>
                        <span class="ms-2">Nevos Melanocíticos</span>
                        <span class="severity-indicator severity-baja ms-auto">Baja</span>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <div class="info-item">
                    <i class="fas fa-file-image text-warning"></i>
                    <div>
                        <strong>Formatos Soportados</strong>
                        <p class="mb-0 text-muted small">JPG, JPEG, PNG (máx. 10MB)</p>
                    </div>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-user-shield text-danger"></i>
                    <div>
                        <strong>Aviso Médico</strong>
                        <p class="mb-0 text-muted small">Este sistema es una herramienta de apoyo. Consulte siempre con un profesional médico.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Análisis Recientes Mejorados -->
        {% if recent_predictions %}
        <div class="card recent-analysis">
            <div class="card-header bg-gradient-info">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-history me-2"></i>
                    Análisis Recientes
                </h5>
                <small class="text-light opacity-75">Últimas {{ recent_predictions|length }} predicciones</small>
            </div>
            <div class="card-body">
                {% for prediction in recent_predictions %}
                <div class="analysis-item fade-in-up" style="animation-delay: 0.{{ forloop.counter0 }}s">
                    <div class="analysis-image">
                        {% if prediction.image %}
                        <img src="{{ prediction.image.url }}" alt="Análisis #{{ prediction.id }}" 
                             class="analysis-image">
                        {% else %}
                        <div class="analysis-image bg-light d-flex align-items-center justify-content-center">
                            <i class="fas fa-image text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="analysis-details">
                        <div class="analysis-title">
                            {{ prediction.get_predicted_disease_name|default:"Análisis en proceso" }}
                            {% if prediction.predicted_class %}
                            <span class="badge 
                                {% if prediction.predicted_class in 'mel,bcc' %}badge-danger
                                {% elif prediction.predicted_class in 'akiec,vasc' %}badge-warning
                                {% else %}badge-success{% endif %} ms-2">
                                {{ prediction.predicted_class|upper }}
                            </span>
                            {% endif %}
                        </div>
                        
                        {% if prediction.confidence %}
                        <div class="analysis-confidence">
                            Confianza: {{ prediction.get_confidence_percentage }}%
                        </div>
                        {% endif %}
                        
                        <div class="analysis-date">
                            {{ prediction.uploaded_at|timesince }} atrás
                        </div>
                    </div>
                    
                    <div class="analysis-actions">
                        <a href="{% url 'skin_detector:prediction_detail' prediction.id %}" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
                        </div>
                        <div class="col-9">
                            <h6 class="mb-1">{{ prediction.get_predicted_disease_name }}</h6>
                            <small class="text-muted">
                                <i class="fas fa-percentage me-1"></i>
                                {{ prediction.get_confidence_percentage }}% confianza
                            </small><br>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                {{ prediction.processed_at|timesince }} atrás
                            </small>
                            <div class="mt-2">
                                <a href="{% url 'skin_detector:prediction_detail' prediction.pk %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Ver Detalles
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <div class="text-center">
                    <a href="{% url 'skin_detector:history' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-history me-1"></i>
                        Ver Todo el Historial
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Advertencia -->
<div class="modal fade" id="warningModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Advertencia Médica
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Este sistema es solo una herramienta de apoyo y NO reemplaza el criterio médico profesional.</strong></p>
                <ul>
                    <li>Los resultados pueden tener errores</li>
                    <li>Siempre consulte a un dermatólogo certificado</li>
                    <li>No tome decisiones médicas basándose únicamente en esta herramienta</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    Entiendo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Setup drag and drop
    setupDragDrop('#dropZone', $('#id_image'));
    
    // Click en drop zone
    $('#dropZone').click(function() {
        $('#id_image').click();
    });
    
    // Preview de imagen principal
    $('#id_image').change(function() {
        if (this.files && this.files[0]) {
            previewImage(this, '#imagePreview');
            $('#previewContainer').show();
        }
    });
    
    // Formulario principal
    $('#uploadForm').submit(function() {
        if (!$('#id_image')[0].files.length) {
            alert('Por favor selecciona una imagen');
            return false;
        }
        showLoading(true);
        $('#warningModal').modal('show');
        return true;
    });
    
    // Análisis rápido
    $('#quickForm').submit(function(e) {
        e.preventDefault();
        
        if (!$('#quickImage')[0].files.length) {
            alert('Selecciona una imagen para análisis rápido');
            return;
        }
        
        var formData = new FormData();
        formData.append('image', $('#quickImage')[0].files[0]);
        
        $.ajax({
            url: '{% url "skin_detector:quick_predict" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function() {
                $('#quickResult').html('<div class="text-center"><div class="spinner-border text-primary"></div><p>Analizando...</p></div>').show();
            },
            success: function(response) {
                if (response.success) {
                    displayQuickResult(response.result);
                } else {
                    $('#quickResult').html('<div class="alert alert-danger">Error: ' + response.error + '</div>');
                }
            },
            error: function() {
                $('#quickResult').html('<div class="alert alert-danger">Error en el servidor</div>');
            }
        });
    });
});

function resetForm() {
    $('#uploadForm')[0].reset();
    $('#previewContainer').hide();
    $('#quickResult').hide();
    $('#quickForm')[0].reset();
}

function displayQuickResult(result) {
    var severityClass = getSeverityClass(result.disease_info.severity);
    
    var html = `
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Resultado del Análisis</h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center mb-3">
                    <div class="col-4">
                        <div class="progress-circle mx-auto" data-percentage="${result.confidence_percentage}">
                            <div class="progress-text">${result.confidence_percentage}%</div>
                        </div>
                    </div>
                    <div class="col-8">
                        <h5>${result.class_name_spanish}</h5>
                        <span class="severity-badge ${severityClass} text-white">${result.disease_info.severity}</span>
                    </div>
                </div>
                <p class="small">${result.disease_info.description}</p>
                <div class="alert alert-info">
                    <strong>Recomendación:</strong> ${result.disease_info.recommendation}
                </div>
                <small class="text-muted">Procesado en ${result.processing_time}s</small>
            </div>
        </div>
    `;
    
    $('#quickResult').html(html);
    
    // Actualizar círculo de progreso
    updateProgressCircle('#quickResult .progress-circle', result.confidence_percentage);
}

function getSeverityClass(severity) {
    switch(severity.toLowerCase()) {
        case 'baja': return 'severity-baja';
        case 'moderada': return 'severity-moderada';
        case 'alta': return 'severity-alta';
        case 'muy alta': return 'severity-muy-alta';
        default: return 'severity-baja';
    }
}
</script>
{% endblock %}
